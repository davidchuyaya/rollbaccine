#!/bin/bash
# Script used to modify all tests generated by ACE.
# Tests were generated with the following script: python3 ace.py -l 1 -n True -d False -t xfstest

# Create group.list file, with all tests belonging in the "auto" group
touch group.list
for i in {1..587};
do
  echo "$i auto" >> group.list
donev

# Remove the flag that requires us to be on raw Linux
sed -i '/_supported_os Linux/d' *

# Modify the tests to check state against the backup, instead of umounting and remounting
# Replace these lines in check_consistency:
	# before=$(general_stat "$@")
	# _flakey_drop_and_remount
	# after=$(general_stat "$@")
# With the following:
    # before=$(general_stat "$1")
    # after=$(general_stat "$2")
    
sed -i 's/before=.*/before=\$\(general_stat\ \"\$1\"\)/g' *
sed -i '/_flakey_drop_and_remount/d' *
sed -i 's/after=.*/after=\$\(general_stat\ \"\$2\"\)/g' *

# Replace these lines:
    # check_consistency $SCRATCH_MNT/?
# With the following:
    # check_consistency $SCRATCH_MNT/? /mnt/newfsbackup/?
# Where we assume that the backup is mounted at /mnt/newfsbackup
sed -i 's/check_consistency \$SCRATCH_MNT\(.*\)/check_consistency \$SCRATCH_MNT\1 \/mnt\/newfsbackup\1/g' *